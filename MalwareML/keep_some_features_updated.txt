#!/usr/bin/env python3
import os
import sys
import json

DEBUG = os.environ.get('DEBUG', 'False').lower() in ['true', 't', '1']

def printd(*args, **kwargs):
    if DEBUG:
        print(*args, **kwargs)


if __name__ == '__main__':
    if len(sys.argv) < 3:
        print('Usage: ./keep_good_prologues.py interesting_prologues.txt feature_file.json [feature_file.json, ...]')
        print('This program will remove "bad" prologues from all featuer files passed to it')
        print('If you try to pass in too many at once, you many get an bash error because the arguement list is too long')
        print('I usually do something like:')
        print('for x in 0 1 2 3 4 5 6 7 8 9 a b c d e f; do /storage/utils/analysis/keep_good_prologues.py interesting_prologues.txt goodware/$x*; done`')
        sys.exit()

    good_prologue_file_path = sys.argv[1]
    feature_file_paths = sys.argv[2:]

    with open(good_prologue_file_path) as f:
        good_prologues = [l.strip() for l in f]

    for i, ff_path in enumerate(feature_file_paths):
        with open(ff_path) as f:
            ff_json = json.load(f)
        ff_json = {k:v for k, v in ff_json.items() 
                     if ('PROLOGUE' not in k or k in good_prologues)}
        with open(ff_path, 'w') as f:
            json.dump(ff_json, f, indent=4, sort_keys=True)
        if i%10==0:
            printd('Processed item {}'.format(i))
    print('Done {} items'.format(i+1))